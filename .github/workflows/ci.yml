# Cross-platform CI/CD for CSEMInsight
# Tests frontend build and backend setup on macOS, Windows, and Linux

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  # ============================================
  # Frontend Build & Test (React + Vite + TypeScript)
  # ============================================
  frontend:
    name: Frontend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [22]

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint
        continue-on-error: true  # Don't fail the build on lint warnings

      - name: Build for production
        run: bun run build

      - name: Run tests
        run: bun run test --run
        continue-on-error: true  # Tests may not be fully set up yet

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest'  # Only upload from one OS
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # ============================================
  # Backend Setup & Validation (Python + Flask)
  # ============================================
  backend:
    name: Backend (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.12']

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate Python syntax
        run: python -m py_compile main.py csem_datafile_parser.py

      - name: Check imports work
        run: |
          python -c "import flask; print(f'Flask {flask.__version__}')"
          python -c "import numpy; print(f'NumPy {numpy.__version__}')"
          python -c "import pandas; print(f'Pandas {pandas.__version__}')"
          python -c "import scipy; print(f'SciPy {scipy.__version__}')"

  # ============================================
  # Combined Status Check
  # ============================================
  ci-success:
    name: CI Success
    needs: [frontend, backend]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.frontend.result }}" == "failure" ]] || [[ "${{ needs.backend.result }}" == "failure" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
