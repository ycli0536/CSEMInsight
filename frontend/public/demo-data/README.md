# CSEMInsight Demo Data

This directory contains preprocessed demo datasets for the static GitHub Pages demo site.

## Contents

- `demo-manifest.json` - Manifest listing available demo datasets
- `data/` - Preprocessed JSON dataset files

## Demo Manifest Schema

The `demo-manifest.json` file uses the following schema:

```json
{
  "version": 1,
  "datasets": [
    {
      "id": "string",           // Authoritative dataset identifier
      "name": "string",          // Display name for UI
      "type": "data" | "resp",   // Dataset type
      "file": "string"           // Relative path from public/ root
    }
  ]
}
```

### ID Strategy

- `datasets[].id` is the **authoritative** dataset identifier
- Embed loader uses manifest IDs to set `Dataset.id` (overrides any JSON `id` field)
- `datasetIds` filtering in the embed API uses these manifest IDs

## Dataset Files

Each JSON file contains a full dataset object matching the backend `/api/load-sample-data` response format:

```json
{
  "id": "<uuid>",
  "name": "Shumagin_Line5_data.json",
  "geometryInfo": {
    "UTM_zone": 0,
    "Hemisphere": "N",
    "North": 0,
    "East": 0,
    "Strike": 0
  },
  "data": "{\"schema\":{...},\"data\":[...]}",
  "dataBlocks": {
    "Format": "...",
    "Geometry": "...",
    "Tx": "...",
    "Rx": "...",
    "Data": "..."
  }
}
```

**Important Notes:**
- `data` field is a JSON **string** in `table` orient (Pandas `to_json` format)
- `dataBlocks` is a dict-like structure (not an array) containing raw parser blocks
- These files are generated by `scripts/preprocess-demo-data.py`

## Embed API

The demo page uses the CSEMInsight Embed API to load datasets without backend dependencies.

### API Signature

```typescript
window.CSEMInsightEmbed.init({
  mountEl: HTMLElement,
  manifestUrl: string,
  baseUrl: string,
  datasetIds?: string[],
}): Promise<void>
```

### Parameters

- **`mountEl`** (required): HTMLElement to mount the application into
- **`manifestUrl`** (required): URL to fetch the demo manifest JSON
- **`baseUrl`** (required): Base URL for resolving relative asset paths
- **`datasetIds`** (optional): Array of dataset IDs to load (filters manifest entries)

### Behavior

- Fetches the manifest from `manifestUrl`
- Resolves dataset file paths relative to `baseUrl`
- Loads each dataset JSON and registers it in the application store
- Applies `datasetIds` filtering if provided (preserves order, warns on unknown IDs)
- First dataset becomes **primary**, subsequent datasets become **compared**
- Calling `init()` multiple times resets datasets and re-mounts the application

### Error Handling

- Returns a `Promise<void>` that rejects on fetch or parse failures
- Unknown dataset IDs are ignored with a console warning
- Invalid manifest schema rejects the promise

### Example Usage

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSEMInsight Demo</title>
</head>
<body>
  <div id="csem-app"></div>
  <script type="module" src="/CSEMInsight/embed/index.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await window.CSEMInsightEmbed.init({
          mountEl: document.getElementById('csem-app'),
          manifestUrl: '/CSEMInsight/demo-data/demo-manifest.json',
          baseUrl: '/CSEMInsight/',
          datasetIds: ['shumagin-line5-data', 'shumagin-line5-resp']
        });
        console.log('Demo loaded successfully');
      } catch (error) {
        console.error('Failed to load demo:', error);
      }
    });
  </script>
</body>
</html>
```

## Dataset Behavior

When loaded via the embed API:

1. **Dataset Registration**: Each dataset is parsed and registered in the application store
2. **Color Assignment**: Datasets are assigned colors from a predefined palette (cycles through 8 colors)
3. **Role Assignment**: 
   - First dataset → `role: 'primary'` (main dataset for plots and tables)
   - Subsequent datasets → `role: 'compared'` (overlay for comparison)
4. **Data Extraction**:
   - CSEM data points parsed from `data` field (JSON string → `CsemData[]`)
   - Tx/Rx data extracted via `getTxRxData()` for navigation plots
   - Geometry info preserved for coordinate transformations

## Demo Data Sources

The demo datasets are derived from:

- **Source**: EMAGE Shumagin Line 5 survey data
- **Files**:
  - `EMAGE_CSEM_Line5_s5_m3.data` → `Shumagin_Line5_data.json`
  - `202406mainP90.24.resp` → `Shumagin_Line5_resp.json`
- **Processing**: Preprocessed via `scripts/preprocess-demo-data.py`

## Updating Demo Data

To regenerate the demo data files:

1. Ensure source `.data` and `.resp` files are available locally
2. Run the preprocessing script:
   ```bash
   cd CSEMInsight
   python scripts/preprocess-demo-data.py \
     --data "/path/to/EMAGE_CSEM_Line5_s5_m3.data" \
     --resp "/path/to/202406mainP90.24.resp" \
     --out "frontend/public/demo-data/data/"
   ```
3. Commit the updated JSON files

## GitHub Pages Deployment

The demo page is built with:

```bash
cd frontend
bun run build:demo
```

This produces a static site under `frontend/dist/` configured for the base path `/CSEMInsight/`. The build output is deployed to GitHub Pages via the `.github/workflows/deploy-pages.yml` workflow.

**Demo URL**: [https://ycli0536.github.io/CSEMInsight/](https://ycli0536.github.io/CSEMInsight/)

## Development Testing

To test the demo locally:

```bash
cd frontend
bun run build:demo
bun run preview
```

Then visit: `http://localhost:4173/CSEMInsight/`

## Stability Contract

The embed API signature and manifest schema are **stable interfaces**. Future changes to the main web app will not affect the demo page as long as:

1. The embed API contract remains unchanged
2. The manifest schema remains backward-compatible
3. Dataset JSON shape matches the documented format

This ensures the demo page continues to work even as the web application evolves independently.
